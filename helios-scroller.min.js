!function(window,angular,TWEEN,undefined){"use strict";angular.module("heliosScroller",["ng","heliosFrameRunner"]).directive("scrollerMaster",["frameRunner",function(raf){return{restrict:"A",link:function($scope,$elem){var transformPrefix,el=$elem,$el=angular.element($elem),windowHeight=window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight,elemHeight=el[0].offsetHeight,scrollableHeight=elemHeight-windowHeight,data={tween:null,direction:{last:0,current:0},progress:{last:{y:0},current:{y:0},rendered:0}};$scope.scrollTotal=0,$scope.percentComplete=0;var Utils={getPrefix:function(prefixes){for(var tmp=document.createElement("div"),result="",i=0;i<prefixes.length;++i){if("undefined"!=typeof tmp.style[prefixes[i]]){result=prefixes[i];break}result=null}return result},render:function(value){transformPrefix?el[0].style[transformPrefix]="translateY("+value+"px)":$el.css("top",value+"px"),data.direction.last=data.direction.current,data.progress.rendered=value,Utils.calculatePercent(value)},tween:{set:function(to,from,time){if(0!==data.direction.last&&data.direction.last!==data.direction.current&&Utils.tween.terminate(),!data.tween){var tm=time||1500,t=to||data.progress.current,f=from||data.progress.last;data.tween=new TWEEN.Tween(f).to(t,tm).easing(TWEEN.Easing.Cubic.Out).onUpdate(function(){Utils.render(this.y)}).onComplete(function(){data.tween=null,data.direction.current=0,data.direction.last=0}).start()}},terminate:function(){data.tween&&(data.tween.stop(),data.tween=null)}},calculatePercent:function(cur){$scope.percentComplete=Math.abs(cur)/scrollableHeight*100},checkRange:function(){$scope.scrollTotal>0?$scope.scrollTotal=0:$scope.scrollTotal<-scrollableHeight&&($scope.scrollTotal=-scrollableHeight)},checkLimit:function(){var dif=$scope.scrollTotal-data.progress.last.y,limit=300;if(dif>limit||-limit>dif){console.log("limiting");var limiter=dif-limit*data.direction.current;$scope.scrollTotal-=limiter/2}}},Handle={wheel:function(event){var e=event||window.event,o=e,w=(o.detail,o.wheelDeltaY||-10*o.deltaY||e.wheelDeltaY===undefined&&e.wheelDelta||e.detail||0),delta=w;return data.direction.current=delta>0?1:-1,$scope.scrollTotal+=delta,Utils.checkRange(),Utils.tween.set(),e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.cancelBubble=!0,e.returnValue=!1,!1},touch:{startY:0,cur:0,lastDelta:0,start:function(e){Handle.touch.startY=Handle.touch.cur=e.pageY,Utils.tween.terminate()},move:function(e){var delta=1.75*(e.pageY-Handle.touch.cur);0!==e.pageY&&(Handle.touch.lastDelta=delta),Handle.touch.cur=e.pageY,data.direction.current=delta>0?1:-1,$scope.scrollTotal+=delta,data.progress.current.y=data.progress.last.y=$scope.scrollTotal,Utils.checkRange(),Utils.render($scope.scrollTotal),e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()},end:function(){$scope.scrollTotal=data.progress.rendered+3*Handle.touch.lastDelta,Utils.checkRange(),Utils.tween.set({y:$scope.scrollTotal},{y:data.progress.rendered})}},key:function(e){if(40===e.keyCode||32===e.keyCode){data.direction.current=-1;var delta=32===e.keyCode?-200:-20}else{if(38!==e.keyCode)return;data.direction.current=1;var delta=20}$scope.scrollTotal+=delta,data.progress.current.y=data.progress.last.y=$scope.scrollTotal,Utils.checkRange(),Utils.render($scope.scrollTotal)}};transformPrefix=Utils.getPrefix(["transform","msTransform","MozTransform","WebkitTransform","OTransform"]),el[0].onwheel=Handle.wheel,el[0].onmousewheel=Handle.wheel,el[0].addEventListener("touchstart",Handle.touch.start,!1),el[0].addEventListener("touchmove",Handle.touch.move,!1),el[0].addEventListener("touchend",Handle.touch.end,!1),window.onkeydown=Handle.key,raf.add("tween","everyFrame",function(){TWEEN.update()}),raf.add("masterScrollTween","everyFrame",function(){$scope.paused||data.tween&&Math.ceil(data.progress.current.y)!==Math.floor($scope.scrollTotal)&&(data.progress.current.y+=($scope.scrollTotal-data.progress.current.y)/2)}),raf.start()}}}])}(window,window.angular,TWEEN);